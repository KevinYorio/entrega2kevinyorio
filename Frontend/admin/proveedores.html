<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ATIX ERP - Proveedores</title>

  <!-- Bootstrap para estilos y componentes -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Script global del admin (auth, fetch helpers, permisos) -->
  <script src="./assets/admin.js"></script>>

  <!-- Estilos generales del ERP -->
  <link rel="stylesheet" href="../css/estilo.css">

  <!-- Estilos del panel admin -->
  <link rel="stylesheet" href="../admin/assets/admin.css">
</head>

<body class="bg-dark text-white">
<div class="admin-shell">

  <!-- SIDEBAR DEL PANEL -->
  <aside class="sidebar">
    <div class="brand">
      <!-- Logo y link a Home -->
      <a href="/index.html" class="d-flex align-items-center gap-2 text-decoration-none">
        <img src="../img/LOGO.webp" alt="ATIX Admin"/>
        <strong>ATIX • ERP</strong>
      </a>
    </div>

    <!-- Menú lateral -->
    <nav class="menu d-grid gap-1">
      <a href="../admin/dashboard.html"><i class="fa-solid fa-gauge"></i>Dashboard</a>
      <a href="../admin/clientes.html"><i class="fa-solid fa-users"></i>Clientes</a>

      <!-- Vista de proveedores (solo admin por el atributo data-admin-only) -->
      <a href="../admin/proveedores.html" data-admin-only><i class="fa-solid fa-truck"></i>Proveedores/Gastos</a>

      <a href="../admin/empleados.html" data-admin-only><i class="fa-solid fa-id-badge"></i>Empleados</a>
      <a href="../admin/facturacion.html"><i class="fa-solid fa-file-invoice-dollar"></i>Facturación</a>
      <a href="../admin/horarios.html"><i class="fa-regular fa-calendar-days"></i>Días y Horarios</a>
      <a class="active" href="../admin/reservas.html"><i class="fa-solid fa-calendar-check"></i>Reservas</a>
      <a href="../admin/reportes.html"><i class="fa-solid fa-chart-line"></i>Reportes</a>
      <a href="../admin/checkin.html"><i class="fa-solid fa-qrcode"></i>Check-in</a>
    </nav>
  </aside>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="d-flex align-items-center gap-2">
      <i class="fa-solid fa-truck text-success"></i>
      <span class="text-muted-2">Proveedores / Gastos</span>
    </div>

    <!-- Usuario logueado y logout -->
    <div class="d-flex align-items-center gap-3">
      <span id="topUser" class="text-muted-2">Admin</span>
      <button class="btn btn-sm btn-outline-light" onclick="localStorage.removeItem('atix_token');location.href='/'">
        Cerrar sesión
      </button>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <main class="main">

    <!-- Encabezado con botón "Nuevo proveedor" -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="m-0">Proveedores / Gastos</h3>
      <button class="btn btn-admin" data-bs-toggle="modal" data-bs-target="#mdlProv">Nuevo proveedor</button>
    </div>

    <!-- TABLA PRINCIPAL -->
    <div class="card p-3">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead>
            <tr><th>Nombre</th><th>Contacto</th><th>Email</th><th>Teléfono</th><th>Último gasto</th><th class="text-end">Acciones</th></tr>
          </thead>
          <tbody id="tbProv"></tbody> <!-- Aquí se cargan los proveedores -->
        </table>
      </div>
    </div>

    <!-- MODAL PARA CREAR/EDITAR PROVEEDOR -->
    <div class="modal fade" id="mdlProv" tabindex="-1">
      <div class="modal-dialog">
        <form id="frmProv" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Proveedor</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <!-- Hidden: ID para edición -->
            <input type="hidden" id="provId">

            <!-- Nombre -->
            <div class="mb-2"><label class="form-label required">Nombre</label>
              <input id="provName" class="form-control" required>
            </div>

            <!-- Contacto -->
            <div class="mb-2"><label class="form-label">Contacto</label>
              <input id="provContact" class="form-control">
            </div>

            <!-- Email -->
            <div class="mb-2"><label class="form-label">Email</label>
              <input id="provEmail" type="email" class="form-control">
            </div>

            <!-- Teléfono -->
            <div class="mb-2"><label class="form-label">Teléfono</label>
              <input id="provPhone" class="form-control">
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
            <button class="btn btn-admin">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- MODAL PARA REGISTRAR GASTO -->
    <div class="modal fade" id="mdlGasto" tabindex="-1">
      <div class="modal-dialog">
        <form id="frmGasto" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Nuevo gasto</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="provIdGasto">

            <!-- Concepto de gasto -->
            <div class="mb-2"><label class="form-label required">Concepto</label>
              <input id="gConcept" class="form-control" required>
            </div>

            <!-- Importe -->
            <div class="mb-2"><label class="form-label required">Importe</label>
              <input id="gAmount" type="number" step="0.01" class="form-control" required>
            </div>

            <!-- Fecha -->
            <div class="mb-2"><label class="form-label">Fecha</label>
              <input id="gDate" type="date" class="form-control">
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
            <button class="btn btn-admin">Registrar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- SCRIPT PRINCIPAL DE LA VISTA -->
    <script>
      // Genera una fila HTML por proveedor
      function rowProv(p){
        const last = p.lastExpense
          ? new Date(p.lastExpense.date).toLocaleDateString() + ' · $' + p.lastExpense.amount
          : '-';

        return `<tr>
          <td>${p.name}</td>
          <td>${p.contact||'-'}</td>
          <td>${p.email||'-'}</td>
          <td>${p.phone||'-'}</td>
          <td>${last}</td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <!-- Se pasa el objeto proveedor serializado -->
              <button class="btn btn-outline-light" onclick='editProv(${JSON.stringify(p).replaceAll("'","&#39;")})'>Editar</button>

              <!-- Registrar gasto -->
              <button class="btn btn-outline-primary" onclick='openGasto(${p.id})'>+ Gasto</button>

              <!-- Eliminar proveedor -->
              <button class="btn btn-outline-danger" onclick='delProv(${p.id})'>Eliminar</button>
            </div>
          </td>
        </tr>`;
      }

      // Lista proveedores desde API
      async function listar(){
        const list = await Admin.apiGet('/providers');
        tbProv.innerHTML = (list.items||list||[]).map(rowProv).join('');
      }

      // Limpia inputs del modal proveedor
      function limpiarProv(){
        provId.value=''; provName.value=''; provContact.value=''; provEmail.value=''; provPhone.value='';
      }

      // Abre modal con datos para editar
      function editProv(p){
        const m = new bootstrap.Modal('#mdlProv'); m.show();
        provId.value=p.id; provName.value=p.name||''; provContact.value=p.contact||''; provEmail.value=p.email||''; provPhone.value=p.phone||'';
      }

      // Abre modal de nuevo gasto
      function openGasto(id){
        const m = new bootstrap.Modal('#mdlGasto'); m.show();
        provIdGasto.value = id; gConcept.value=''; gAmount.value=''; gDate.value='';
      }

      // Eliminar proveedor
      async function delProv(id){
        if(!confirm('¿Eliminar proveedor?')) return;
        await Admin.apiDel('/providers/'+id);
        listar();
      }

      // Submit de proveedor (crear o editar)
      frmProv.onsubmit = async (e)=>{
        e.preventDefault();
        const payload = { name:provName.value.trim(), contact:provContact.value.trim(), email:provEmail.value.trim(), phone:provPhone.value.trim() };

        if(provId.value) await Admin.apiPut('/providers/'+provId.value, payload);
        else             await Admin.apiPost('/providers', payload);

        bootstrap.Modal.getInstance(mdlProv).hide();
        limpiarProv(); 
        listar();
      };

      // Submit del gasto
      frmGasto.onsubmit = async (e)=>{
        e.preventDefault();
        const payload = { concept:gConcept.value.trim(), amount: +gAmount.value, date: gDate.value||null };

        await Admin.apiPost(`/providers/${provIdGasto.value}/expenses`, payload);
        bootstrap.Modal.getInstance(mdlGasto).hide();
        listar();
      };

      // Auto-listar proveedores al cargar la vista
      document.addEventListener('DOMContentLoaded', listar);
    </script>

    <!-- cierre layout común -->
  </main>
</div>

<!-- Iconos -->
<script src="https://kit.fontawesome.com/a2d9d5c36a.js" crossorigin="anonymous"></script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
