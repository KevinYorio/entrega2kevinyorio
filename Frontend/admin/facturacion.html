<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ATIX ERP - Facturación</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Admin core -->
  <script src="./assets/admin.js"></script>

  <!-- Iconos + Estilos del sitio -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
        integrity="sha512-MV7K8+y+gLIBoVD59lQIYicR65iaqukzvf/nwasF0nqhPay5w/9lJmVM2hMDcnK1OnMGCdVK+iQrJ7lzPJQd1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="../css/estilo.css">
  <link rel="stylesheet" href="../admin/assets/admin.css">
</head>
<body class="bg-dark text-white">
<div class="admin-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <a href="/index.html" class="d-flex align-items-center gap-2 text-decoration-none">
        <img src="../img/LOGO.webp" alt="ATIX Admin"/>
        <strong>ATIX • ERP</strong>
      </a>
    </div>
    <nav class="menu d-grid gap-1">
      <a href="../admin/dashboard.html"><i class="fa-solid fa-gauge"></i>Dashboard</a>
      <a href="../admin/clientes.html"><i class="fa-solid fa-users"></i>Clientes</a>
      <a href="../admin/proveedores.html" data-admin-only><i class="fa-solid fa-truck"></i>Proveedores/Gastos</a>
      <a href="../admin/empleados.html" data-admin-only><i class="fa-solid fa-id-badge"></i>Empleados</a>
      <a href="../admin/facturacion.html"><i class="fa-solid fa-file-invoice-dollar"></i>Facturación</a>
      <a href="../admin/horarios.html"><i class="fa-regular fa-calendar-days"></i>Días y Horarios</a>
      <a class="active" href="../admin/reservas.html"><i class="fa-solid fa-calendar-check"></i>Reservas</a>
      <a href="../admin/reportes.html"><i class="fa-solid fa-chart-line"></i>Reportes</a>
      <a href="../admin/checkin.html"><i class="fa-solid fa-qrcode"></i>Check-in</a>
    </nav>
  </aside>

  <!-- TOPBAR -->
  <header class="topbar">
    <div class="d-flex align-items-center gap-2">
      <i class="fa-solid fa-file-invoice-dollar txtRojo"></i>
      <span class="text-muted-2">Panel de administración</span>
    </div>
    <div class="d-flex align-items-center gap-3">
      <span id="topUser" class="text-muted-2">Admin</span>
      <button class="btn btn-sm btn-outline-light" onclick="localStorage.removeItem('atix_token');location.href='/'">
        Cerrar sesión
      </button>
    </div>
  </header>

  <!-- MAIN -->
  <main class="main">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="m-0">Facturación</h3>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light" id="btnGen">Generar facturas (mes)</button>
        <button class="btn btn-admin" data-bs-toggle="modal" data-bs-target="#mdlNewInv">Nueva factura</button>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-md-3"><input id="fQ" class="form-control" placeholder="Buscar alumno/#"/></div>
        <div class="col-md-3">
          <select id="fStatus" class="form-select">
            <option value="">Todos</option>
            <option value="PAID">Pagadas</option>
            <option value="PENDING">Pendientes</option>
            <option value="CANCELLED">Anuladas</option>
          </select>
        </div>
        <div class="col-md-2"><button id="btnF" class="btn btn-outline-light w-100">Filtrar</button></div>
        <button class="btn btn-outline-light btn-sm" onclick="Admin.exportTableCSV('table','alumnos.csv')">Exportar CSV</button>
      </div>
    </div>

    <div class="card p-3">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead><tr><th>#</th><th>Alumno</th><th>Fecha</th><th>Total</th><th>Estado</th><th class="text-end">Acciones</th></tr></thead>
          <tbody id="tbInv"></tbody>
        </table>
      </div>
    </div>

    <!-- Modal nueva factura -->
    <div class="modal fade" id="mdlNewInv" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <form id="frmNewInv" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Nueva factura</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row g-2 mb-2">
              <div class="col-md-6">
                <label class="form-label required">Alumno</label>
                <select id="invStudent" class="form-select"></select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Fecha</label>
                <input id="invDate" type="date" class="form-control">
              </div>
              <div class="col-md-3">
                <label class="form-label">Estado</label>
                <select id="invStatus" class="form-select">
                  <option value="PENDING">PENDIENTE</option>
                  <option value="PAID">PAGADA</option>
                </select>
              </div>
            </div>
            <div>
              <table class="table table-sm align-middle">
                <thead><tr><th>Descripción</th><th style="width:140px;">Cant</th><th style="width:180px;">Precio</th><th style="width:100px;">Subtotal</th><th></th></tr></thead>
                <tbody id="invItems"></tbody>
              </table>
              <button class="btn btn-outline-light btn-sm" type="button" onclick="addItem()">+ Ítem</button>
              <div class="text-end mt-2"><strong>Total: $<span id="invTotal">0</span></strong></div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancelar</button>
            <button class="btn btn-admin">Guardar</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      let alumnosCache=[];
      function rowInv(i){
        return `<tr>
          <td>${i.number || i.id}</td>
          <td>${i.studentName||'-'}</td>
          <td>${new Date(i.date).toLocaleDateString()}</td>
          <td>$${i.total}</td>
          <td><span class="badge ${i.status==='PAID'?'bg-success':(i.status==='CANCELLED'?'bg-secondary':'bg-warning')}">${i.status}</span></td>
          <td class="text-end">
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-light" onclick="markPaid(${i.id})">Marcar pagada</button>
              <button class="btn btn-outline-danger" onclick="cancelInv(${i.id})">Anular</button>
            </div>
          </td>
        </tr>`;
      }
      async function listar(){
        const p = new URLSearchParams();
        if(fQ.value.trim()) p.set('q',fQ.value.trim());
        if(fStatus.value)   p.set('status',fStatus.value);
        const list = await Admin.apiGet('/invoices?'+p.toString());
        tbInv.innerHTML = (list.items||list||[]).map(rowInv).join('');
      }
      btnF.onclick = listar;
      async function markPaid(id){ await Admin.apiPost(`/invoices/${id}/pay`,{}); listar(); }
      async function cancelInv(id){ if(!confirm('¿Anular factura?'))return; await Admin.apiPost(`/invoices/${id}/cancel`,{}); listar(); }
      btnGen.onclick = async ()=>{ if(!confirm('Generar facturas del mes a alumnos con plan activo?')) return; await Admin.apiPost('/invoices/generate-month',{}); listar(); };

      // Nueva factura
      function addItem(desc='', qty=1, price=0){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="form-control form-control-sm desc" value="${desc}"></td>
          <td><input type="number" class="form-control form-control-sm qty" value="${qty}" step="1" min="1"></td>
          <td><input type="number" class="form-control form-control-sm price" value="${price}" step="0.01" min="0"></td>
          <td class="subt">0</td>
          <td><button class="btn btn-sm btn-outline-danger" type="button" onclick="this.closest('tr').remove();calcTotal()">X</button></td>
        `;
        document.getElementById('invItems').appendChild(tr);
        ['input','change'].forEach(evt=>tr.addEventListener(evt, calcTotal));
        calcTotal();
      }
      function calcTotal(){
        let total=0;
        document.querySelectorAll('#invItems tr').forEach(tr=>{
          const qty = +tr.querySelector('.qty').value || 0;
          const price = +tr.querySelector('.price').value || 0;
          const sub = qty*price;
          tr.querySelector('.subt').textContent = sub.toFixed(2);
          total+=sub;
        });
        document.getElementById('invTotal').textContent = total.toFixed(2);
      }
      frmNewInv.onsubmit = async (e)=>{
        e.preventDefault();
        const items = Array.from(document.querySelectorAll('#invItems tr')).map(tr=>({
          description: tr.querySelector('.desc').value.trim(),
          qty: +tr.querySelector('.qty').value || 0,
          price: +tr.querySelector('.price').value || 0
        })).filter(i=>i.description && i.qty>0);
        const payload = {
          studentId: +invStudent.value,
          date: invDate.value || new Date().toISOString().slice(0,10),
          status: invStatus.value || 'PENDING',
          items
        };
        await Admin.apiPost('/invoices', payload);
        bootstrap.Modal.getInstance(mdlNewInv).hide();
        document.getElementById('invItems').innerHTML=''; addItem(); listar();
      };
      document.addEventListener('DOMContentLoaded', async ()=>{
        alumnosCache = await Admin.apiGet('/students?limit=1000');
        invStudent.innerHTML = (alumnosCache.items||alumnosCache||[]).map(a=>`<option value="${a.id}">${a.firstName} ${a.lastName} (${a.email})</option>`).join('');
        addItem();
        listar();
      });
    </script>

  </main>
</div>

<!-- JS -->
<script src="https://kit.fontawesome.com/a2d9d5c36a.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
